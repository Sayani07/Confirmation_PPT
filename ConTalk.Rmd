---
title: "Visualisation and analysis of probability distributions of variables defined on  spatio-temporal granularities"
type: "meetup"
author: "<br> Sayani Gupta <br>"
date: "February 28, 2019 <br>"
output:
  xaringan::moon_reader:
    css: ["default", "remark.css"]
    self_contained: false
    nature:
      ratio: 16:9
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
library(tidyverse)
library(sugrrants)
library(tsibble)
library(ggridges)
library(viridis)
library(forecast)
library(lubridate)
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, cache=TRUE, dev.args=list(bg=grey(0.9), pointsize=8))
```

# <span style="color:DarkBlue"> Agenda

- Motivation

- Research Aim

- What is EDA? How it can help?

- Research Objectives
  - Visualization of probability distributions of deconstructed temporal data
  - Visualization of probability distributions of deconstructed spatio- temporal data
  - Clustering of spatio-temporal data based on probability distributions
  
- Visualization of probability distributions of deconstructed temporal data

- Timeline

---

# <span style="color:DarkBlue"> Motivation

## Electricity smart meter technology 

Smart meters record electricity usage (per kWh) every 30 minutes and send this information to the electricity retailer for billing

.pull-left[

**Consumers** can save considerable amount on their electricity bill by 
<br>
- Switching on their hot water heater or do laundry when energy is cheaper, or when their solar system is generating surplus energy 

- Switching off appliances during peak demands

- Check usage and compare with similar homes 

<!-- All homes and businesses in Victoria are already fitted with smart meters -->

<!-- Both consumers and retailers benefit from greater electricity consumption information -->
]
.pull-right[

**Retailers** can reduce costs and increase efficiency
<br>
<br>
- lower metering and connection fees 

- Draw insights into when customer is home, or sleeping, or even what appliances they are using based on usage figures

- Reward customers for mindful usage
]

---

## <span style="color:DarkBlue">  Data description (~ 40 billion half hourly observations)

.pull-left[

.large[Source]
<br>
<br>
<br>
.large[Frequency]
<br>
<br>
<br>
.large[Time Frame]
<br>
<br>
<br>
.large[Spread]
<br>
<br>
<br>
Type
]

.pull-right[

Data61, CSIRO
<br>
<br>
<br>
Half hourly interval meter reading (Kwh)
<br>
<br>
<br>
2012 to 2014
<br>
<br>
<br>
14K (approx.) households based in Newcastle, New South Wales, and parts of Sydney
<br>
<br>
Spatio - Temporal Data
]
---
## <span style="color:DarkBlue">  Research Aim

---
## <span style="color:DarkBlue">  What is Exploratory Data Analysis?

.pull-left[
<br>
.center[
<img src="EDA.png" height=400px>
]
]
.pull-right[
<br>
<br>
Developed by **John Tukey** as a way of _*systematically*_ using the tools of statistics on a problem before a hypotheses about the data were developed

### <span style="color:DarkBlue"> How can it help?

 - Big problem broken into pieces by focussing on subsets
<br>
<br>
 - Visualization of <span style="color:Crimson"> probability distributions <span style="color:Black"> at varying resolutions of time and space
<br>
<br>
 - Find regular patterns/ anomalies or pockets of similar behavior
<br>
<br>
 - Each visual representation poses a question
<br>
<br>
 - Action: draw insights or refine question
]

---

# <span style="color:DarkBlue"> Research goals

### <span style="color:#c33c3c"> Visualization of probability distributions of deconstructed temporal data
<br>
<br>
### <span style="color:#c33c3c"> Visualization of probability distributions of deconstructed spatio- temporal data
<br>
<br>
### <span style="color:#c33c3c"> Clustering of spatio-temporal data based on probability distributions
<br>
<br>
---
class: middle center

# <span style="color:DarkBlue"> Visualization of probability distributions of deconstructed temporal data

---

## <span style="color:DarkBlue"> Deconstructing temporal data - Granularities

.pull-left[
#### Arrangement of time : a) Linear or b) Cyclic
]

.pull-right[
.center[<img src="Linear-Circular.png" height=280px>]
]

#### <span style="color:#c33c3c"> **Granularities** <span style="color:Black">  Abstractions of time based on Calendar

#### <span style="color:#c33c3c"> **Linear granularities** <span style="color:Black"> : Days, weeks, months, years

#### <span style="color:#c33c3c"> **Circular granularities** <span style="color:Black"> : DoW, MoY or HOD and nearly circular granularities like DoM or WoM   
 
---

## <span style="color:DarkBlue"> Visualizing distributions across circular granularities (I)

<!-- Data description:  30 minutes interval smart meter data from Monash Residential Services from April 4, 2018 to May 31, 2018 -->

```{r okaygraph1, out.width="50%",echo=FALSE}
load("Units_Data.Rdata")

Units_Data$`Timestamp UTC` <-lubridate::ymd_hms(Units_Data$`Timestamp UTC`)


vic_holidays <- holiday_aus(2018, state = "VIC")

SU_uniform_mutate <-Units_Data  %>% mutate(date = date(`Timestamp UTC`),wday = wday(date, label = TRUE, abbr = TRUE,
                       week_start = 1),
                       month = month(date, label = TRUE, abbr = TRUE),
                       year = year(date),
                       hour = hour(`Timestamp UTC`),
                       work = ifelse(wday %in% c("Mon", "Tue", "Wed", "Thu", "Fri"), 1, 0), work = ifelse(date %in% vic_holidays$date, 0, 1))
                       
                       
p1 = SU_uniform_mutate %>% filter(Source=="B1 05") %>%
  group_by(date) %>%
  summarise(dkwh = sum(Value, na.rm=TRUE)) %>%
  mutate(wday = wday(date, label = TRUE, abbr = TRUE,
                     week_start = 1)) %>%
  ggplot(aes(x=wday, y=dkwh)) + geom_boxplot()   
   
p2 = SU_uniform_mutate %>% filter(Source=="B4 29") %>%
  group_by(date) %>%
  summarise(dkwh = sum(Value, na.rm=TRUE)) %>%
  mutate(wday = wday(date, label = TRUE, abbr = TRUE,
                     week_start = 1)) %>%
  ggplot(aes(x=wday, y=dkwh)) + geom_boxplot()

grid.arrange(p1, p2,  nrow = 2)

```
---
## Across hours, by day of the week

```{r okaygraph2, out.width="50%",echo=FALSE}
p3 = SU_uniform_mutate %>% filter(Source=="B1 05") %>%
  group_by(wday,hour) %>%
  ggplot(aes(x=as.factor(hour), y=Value,group=hour)) + geom_boxplot() +
  facet_wrap(~wday) + 
  ylab("Total kwh") +
  xlab("Hours")

p4 = SU_uniform_mutate %>% filter(Source=="B4 29") %>%
  group_by(wday,hour) %>%
  ggplot(aes(x=as.factor(hour), y=Value, group=hour)) + geom_boxplot() +
  facet_wrap(~wday) + 
  ylab("Total kwh") +
  xlab("Hours") + scale_x_discrete(breaks = seq(1,24,2))  

grid.arrange(p3, p4,  nrow = 2)

```
---

## Across hours, by work days and non-work days

```{r okaygraph, out.width="50%",echo=FALSE}
 s1 <- SU_uniform_mutate %>%
  mutate(work = ifelse(date %in% vic_holidays$date, 0, work))

 
b1_Quantile <- s1 %>% filter(Source=="B1 05") %>% group_by(work,hour) %>% 
   do({x <- .$Value
   map_dfr(.x = seq(0.1,0.9,0.1),
           .f = ~ tibble(Quantile = .x,
                             Value = quantile(x, probs = .x,na.rm=TRUE)))
   })
 
p5 <- b1_Quantile %>% ggplot(aes(x=hour,y=Value,col=as.factor(Quantile))) +geom_line() + scale_x_continuous(breaks=seq(1, 24, 1)) +theme(legend.position = "bottom") + facet_wrap(~work, labeller = "label_both") + ylab("Total kwh") +  xlab("Hours")  
  
b2_Quantile <- s1 %>% filter(Source=="B4 29") %>% group_by(work,hour) %>% 
   do({x <- .$Value
   map_dfr(.x = seq(0.1,0.9,0.1),
           .f = ~ tibble(Quantile = .x,
                             Value = quantile(x, probs = .x,na.rm=TRUE)))
   })
 
p6 <- b2_Quantile %>% ggplot(aes(x=hour,y=Value,col=as.factor(Quantile))) +geom_line() + scale_x_continuous(breaks=seq(1, 24, 1)) +theme(legend.position = "bottom") + facet_wrap(~work, labeller = "label_both") + ylab("Total kwh") +  xlab("Hours")  

grid.arrange(p5, p6,  nrow = 2)


```
---


## <span style="color:DarkBlue"> Visualizing distributions across circular granularities (II)

#### Learning 1 - Aggregating information across different circular granularities can communicate completely different aspects of data

-- 

#### Learning 2 - Exhaustive sets of visual representation required to get multiple perspectives on data

-- 

#### Question: Can all combinations of these circular granularities be plotted?

--- 

<!-- Data description: 15 minutes interval state level smart meter data of Victoria from January, 2002 to December, 2014 -->


```{r moy-dom,echo=FALSE, out.width = "70%", fig.align = 'center',fig.cap ="Letter-value plot of electricity consumption in Victoria across days of the month\n faceted by months January, February, April and December. "}

VIC <- read.csv("VIC2015/Data/demand_VIC.csv")
VIC$Date <- as.Date(VIC$Date,origin = "1899-12-30")

first_day_of_month_wday <- function(dx) {
  day(dx) <- 1
  wday(dx)
}

VIC <- VIC %>%mutate(Indx_Year = year(Date),
                     Indx_Month = month(Date, label = FALSE, abbr = TRUE),
                     Indx_Wk_Yr = week(Date),
                     Indx_Wk_Month = ceiling((day(Date) + first_day_of_month_wday(Date) - 1) / 7),
                     Indx_Day_Week = wday(Date, label=FALSE, abbr=TRUE,
                                          week_start=1),

                     Indx_Day_Month = day(Date),

                     Indx_Day_Year =  yday(Date),

                     Indx_Weekend=if_else(Indx_Day_Week %in% c(6,7),1,0),

                     Indx_HlHr_day = Period,
                     month = month(Date, label = FALSE, abbr = TRUE),
         year =  year(Date),
         yday =yday(Date),
         wday = wday(Date, label=FALSE, abbr=TRUE,
                     week_start=1),
         bow = (wday - 1) * 48 + Period,
         dom = day(Date),
         bom = (dom - 1) * 48 + Period,
         Weekend=if_else(wday %in% c(6,7),1,0),
         Indx_hour = ceiling(Period/2),
         Indx_Hour_Yr = Indx_hour + 24*(yday-1),
         Indx_Hour_Month = Indx_hour + 24*(Indx_Day_Month-1),
         Indx_Hour_Wk = Indx_hour + 24*(wday-1))
         
         


VIC <- as_tibble(VIC)
```
---

```{r allFig, fig.height=5, out.width="70%",echo=FALSE, eval=TRUE, fig.align="left"}
library(lvplot)
library(gridExtra)

par(mfrow = c(2, 2))

p1 <- VIC%>% filter(year %in% c(2012, 2013, 2014),Indx_Day_Month %in% c(1,15,29,31))%>% ggplot(aes(yday,OperationalLessIndustrial,group = yday)) + geom_boxplot(width=10)+ facet_wrap(~Indx_Day_Month) + ylab("Electricity Demand [KWh]") +
  xlab("Days of the Year") + scale_x_discrete(breaks=seq(0,366,60)) +theme(legend.position = "bottom",strip.text = element_text(size = 7, margin = margin())) + ggtitle("(c) Boxplot")



p2 <- VIC%>% filter(year %in% c(2012, 2013, 2014),Indx_Wk_Month %in% c(1,2,4))%>% ggplot(aes(as.factor(Indx_Day_Month),OperationalLessIndustrial)) + geom_violin(alpha = 0.03)+ facet_wrap(~Indx_Wk_Month,nrow=3) + ylab("") + xlab("Days of the Month") + theme(legend.position = "bottom",strip.text = element_text(size = 7, margin = margin())) + scale_x_discrete(breaks=seq(0,31,5))+ scale_y_continuous(breaks = seq(2000,9000,2000))+ ggtitle("(d) Violin plot")


p3 <- VIC%>% dplyr:::filter(year %in% c(2012, 2013, 2014),Indx_Wk_Month %in% c(1,2,5),Indx_Wk_Yr <20)%>% ggplot(aes(x=OperationalLessIndustrial,y=as.factor(Indx_Wk_Yr),group=Indx_Wk_Yr)) + geom_density_ridges2() +facet_wrap(~Indx_Wk_Month) + xlab("Electricity Demand [KWh]") + ylab("Weeks of the Year") + scale_x_continuous(breaks = seq(2000,10000,3000)) + theme(legend.position = "bottom",strip.text = element_text(size = 7, margin = margin())) + ggtitle("(e) Ridge plot")


VIC_moy_doy <- VIC%>% filter(year %in% c(2012, 2013, 2014)) %>%
  group_by(Indx_Month,yday) %>%
  do({x <- .$OperationalLessIndustrial
  map_dfr(.x = seq(0.1,0.9,0.1),
          .f = ~ tibble(Quantile = .x,
                            Value = quantile(x, probs = .x,na.rm=TRUE)))
  }) %>%  filter(Indx_Month %in% c(1,7,11))

p4 <- VIC_moy_doy %>%ggplot(aes(x=yday,y=Value,col=as.factor(Quantile),group=yday)) + geom_line() + facet_wrap(~Indx_Month)+ scale_x_continuous(breaks=seq(1, 336, 60)) + ylab("")  + xlab("Day of the Year") + theme(legend.position = "none",strip.text = element_text(size = 7, margin = margin())) + ggtitle("(f) Decile plot")

grid.arrange(p1, p2, p3, p4, ncol = 2)

```
---


## <span style="color:DarkBlue"> Harmonies and Clashes

**Harmonies** Combinations of circular granularities which facilitate EDA when plotted together

**Clashes** Combinations of circular granularities which are conflicts in bringing out the best of EDA when plotted together

--

<span style="color:#c33c3c"> To formalize the theory to show why some displays work while are others unacceptable for most plausible purposes for effective display of quantitative phenomena.

---

##Structurally Empty Combinations

##Non-functional Empty Combinations



## Timeline
```{r timeline, echo=FALSE}
library(DiagrammeR)

mermaid("
gantt
dateFormat  YYYY-MM-DD

section 2019
Candidature Confirmation      :done,          first_1,    2019-01-01, 2014-02-28
Research Aim - 1 (Paper)      :active,        first_2,    2019-01-09, 2019-04-30
Research Aim - 1 (R Package)  :active,        first_3,    2019-01-03, 2019-05-31
geom_hdr (R Package)          :active,        first_4,    2019-01-04, 2019-06-30
Internship                    :active,        first_5,    2019-06-01, 2019-07-31
Research Aim-2                :active         first_6,    2019-07-01, 2019-12-31

section 2020
Completed, critical task      :crit, done,    import_1,   2014-01-06,24h
Also done, also critical      :crit, done,    import_2,   after import_1, 2d
Doing this important task now :crit, active,  import_3,   after import_2, 3d
Next critical task            :crit,          import_4,   after import_3, 5d

section 2021
First extras                  :active,        extras_1,   after import_4,  3d
Second helping                :               extras_2,   after extras_1, 20h
More of the extras            :               extras_3,   after extras_1, 48h
")
```

<!-- ```{r b105_days,echo=FALSE} -->

<!-- Data_Halls_Residence <-read_rds("/Users/sgup0008/Documents/MRS_Consumption/DHResidence.rds") -->


<!-- selected_units <- Data_Halls_Residence %>% filter(Source %in% c("B1 05","B2 15","B3 37", "B4 29", "BG 50")) -->

<!-- selected_units$`Timestamp UTC` <- lubridate::ymd_hms(selected_units$`Timestamp UTC`) -->

<!-- selected_units_tsibble <- as_tsibble(selected_units,key=id(Source),index=`Timestamp UTC`,tz="UTC") -->


<!-- SU_Date <-selected_units %>% mutate(Date = as.POSIXct(`Timestamp UTC`,  format = "%Y-%m-%d %H:%M")) -->

<!-- date.range = range(selected_units$`Timestamp UTC`) -->

<!-- Reference_time =  seq( -->
<!--   from=as.POSIXct(date.range[1], tz='UTC',"%Y-%m-%d %H:%M"), -->
<!--   to=as.POSIXct(date.range[2], tz='UTC',"%Y-%m-%d %H:%M"), -->
<!--   by='15 min' -->
<!-- ) -->


<!-- SU_Date.uniform <- expand.grid(time=Reference_time, -->
<!--                           source=unique(SU_Date$Source)) %>% -->
<!--   left_join(SU_Date, by=c('time'='Date'), 'source') -->




<!-- vic_holidays <- holiday_aus(2018, state = "VIC") -->
<!-- SU_uniform_mutate <- SU_Date.uniform %>% mutate(date = date(time),wday = wday(time, label = TRUE, abbr = TRUE, -->
<!--                       week_start = 1), -->
<!--                       month = month(time, label = TRUE, abbr = TRUE), -->
<!--                       year = year(time), -->
<!--                       hour = hour(time),work = ifelse(wday %in% c("Mon", "Tue", "Wed", "Thu", "Fri"), 1, 0)) %>% -->
<!--                         mutate(work = ifelse(date %in% vic_holidays$date, 0, work)) -->



<!--  s1 <- SU_uniform_mutate %>% filter(Source=="B4 29") %>% mutate(work = ifelse(wday %in% c("Mon", "Tue", "Wed", "Thu", "Fri"), 1, 0)) %>% -->
<!--   mutate(work = ifelse(date %in% vic_holidays$date, 0, work)) -->

<!--  s2 <- ts(s1$Value,frequency = 48) -->

<!--  autoplot(s2) + ylab("Total kwh") -->
<!-- ``` -->



<!-- ###Volume : Approx. 40 billion half hourly observations   -->

<!-- --- -->
<!-- ### <span style="color:DarkBlue"> Data description (~ 40 billion half hourly observations) -->

<!-- .pull-left[ -->
<!-- #### Source -->
<!-- ] -->
<!-- .pull-right[Data61, CSIRO -->
<!-- ] -->
<!-- -- -->
<!-- .pull-left[ -->
<!-- #### Frequency -->
<!-- ] -->
<!-- .pull-right[Half hourly interval meter reading (Kwh) -->
<!-- ] -->
<!-- -- -->
<!-- .pull-left[ -->
<!-- #### Time Frame -->
<!-- ] -->
<!-- .pull-right[2012 to 2014 -->
<!-- ] -->
<!-- -- -->
<!-- .pull-left[ -->
<!-- #### Spread -->
<!-- ] -->
<!-- .pull-right[14K (approx.) households based in Newcastle, New South Wales, and parts of Sydney -->
<!-- ] -->
<!-- --- -->

<!-- Challenge for visualisation is handling the volume of data supplied by smart meters and derive insights for efficient usage. -->
